import logging
import stripe
from api.models.stripe_intent_models import StripeIntentModel
from django.conf import settings
logger = logging.getLogger(__name__)

logger.info("INFO: Starting stripe_intent_service")
stripe.api_key = settings.STRIPE_SECRET_KEY  # Ensure it's in settings

def create_or_get_payment_intent(amount, currency="GBP"):
    logger.info(" [StripeIntent] Called create_or_get_payment_intent()")
    logger.info(f" Incoming Amount: {amount}, Currency: {currency}")
    existing_session = StripeIntentModel.objects.filter(
        status="requires_payment_method",
        amount=amount,
        currency=currency,
        donation_id__isnull=True
    ).order_by('-created_at').first()

    if existing_session:
        logger.info(" Reusing existing StripeIntentModel")
        logger.info(f" Existing Intent ID: {existing_session.payment_intent_id}")
        logger.info(f" Client Secret: {existing_session.client_secret}")
        return {
            "client_secret": existing_session.client_secret,
            "payment_intent_id": existing_session.payment_intent_id,
            "status": existing_session.status,
            "message": "Reusing existing PaymentIntent"
        }
    logger.info(" No reusable session found. Creating new PaymentIntent...")

    intent = stripe.PaymentIntent.create(
        amount=int(amount),
        currency=currency,
    )

    logger.info(" New PaymentIntent Created:")
    logger.info(f" ID: {intent.id}")
    logger.info(f" Client Secret: {intent.client_secret}")
    logger.info(f" Status: {intent.status}")

    session = StripeIntentModel.objects.create(
        payment_intent_id=intent.id,
        client_secret=intent.client_secret,
        status=intent.status,
        amount=amount,
        currency=currency
    )
    logger.info(" StripeIntentModel entry created in DB")
    return {
        "client_secret": intent.client_secret,
        "payment_intent_id": intent.id,
        "status": intent.status,
        "message": "PaymentIntent created successfully!"
    }